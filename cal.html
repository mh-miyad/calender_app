<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Calendar ✨ (Alpine.js)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="responsive.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    /* Prevent FOUC (Flash of Unstyled Content) with Alpine */
    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="app-background">
    <div class="calendar-app" x-data="calendarApp()" x-init="init" x-cloak>
      <header class="app-header">
        <h1>AI Calendar ✨</h1>
        <div class="booking-link-container">
          <a href="booking.html" target="_blank" class="action-btn booking-btn">My Booking Page (View Clone)</a>
        </div>
        <div class="controls">
          <button @click="changeMonth(-1)" class="control-btn"><i class="fas fa-chevron-left"></i></button>
          <h2 x-text="`${currentMonthName} ${currentYear}`"></h2>
          <button @click="changeMonth(1)" class="control-btn"><i class="fas fa-chevron-right"></i></button>
          <button @click="openModal()" class="action-btn add-btn">
            <i class="fas fa-plus"></i> Add Event
          </button>
          <button @click="alert('Simulating Google Sync... Requires Backend.')" class="sync-btn"
            title="Connect Google Calendar (Simulation)">G</button>
          <button @click="alert('Simulating Outlook Sync... Requires Backend.')" class="sync-btn"
            title="Connect Outlook Calendar (Simulation)">O</button>
        </div>
      </header>

      <div id="calendar-grid" class="calendar-grid">
        <template x-for="dayHeader in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']" :key="dayHeader">
          <div class="day-header" x-text="dayHeader"></div>
        </template>

        <template x-for="(day, index) in daysInGrid" :key="index">
          <div class="calendar-day" :class="{
                            'other-month': !day.isCurrentMonth,
                            'today': day.isToday
                        }" @click="if (day.isCurrentMonth) openModal(null, day.dateStr)">
            <span class="day-number" x-text="day.dayNum"></span>
            <div class="events-container">
              <template x-for="event in getEventsForDay(day.dateStr)" :key="event.id">
                <div class="event" @click.stop="openModal(event.id)"
                  :title="`${event.title}${event.time ? ' at ' + event.time : ''} (${event.startDate}${event.endDate ? ' to ' + event.endDate : ''})`"
                  :class="{
                                        'multi-day-start': event.endDate && day.dateStr === event.startDate,
                                        'multi-day-middle': event.endDate && day.dateStr !== event.startDate && day.dateStr !== event.endDate,
                                        'multi-day-end': event.endDate && day.dateStr === event.endDate
                                    }">
                  <i :class="getIconClass(event)"></i>
                  <span class="event-text" x-text="event.title"></span>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>

      <div id="reminders-section" class="reminders-section">
        <h2><i class="fas fa-bell"></i> Upcoming</h2>
        <ul id="reminders-list">
          <template x-if="upcomingReminders.length === 0">
            <li><i class="fas fa-moon"></i> No upcoming events.</li>
          </template>
          <template x-for="event in upcomingReminders" :key="event.id">
            <li>
              <i :class="getIconClass(event)" style="margin-right: 8px;"></i>
              <span
                x-text="`${event.title} - ${formatDate(event.dateTime, {weekday: 'short', month: 'short', day: 'numeric'})}${event.time ? ' at ' + event.time : ' (All day)'}${event.endDate && event.startDate !== event.endDate ? ' (until ' + event.endDate + ')' : ''}`"></span>
            </li>
          </template>
        </ul>
      </div>

      <div id="event-modal" class="modal" x-show="isModalOpen" @click.self="closeModal"
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" style="display: none;">
        <div class="modal-content glassmorphic" @click.stop> <button class="close-btn"
            @click="closeModal">&times;</button>
          <h3 id="modal-title" x-text="editingEventId ? 'Edit Event' : 'Create Event'"></h3>
          <form id="event-form" @submit.prevent="saveEvent">
            <div class="form-group">
              <label for="event-title">Title:</label>
              <input type="text" id="event-title" x-model="modalData.title" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="event-start-date">Start Date:</label>
                <input type="date" id="event-start-date" x-model="modalData.startDate" required>
              </div>
              <div class="form-group">
                <label for="event-end-date">End Date:</label>
                <input type="date" id="event-end-date" x-model="modalData.endDate" :min="modalData.startDate">
                <small> (Optional: for multi-day events)</small>
              </div>
            </div>
            <div class="form-group">
              <label for="event-time">Time:</label>
              <input type="time" id="event-time" x-model="modalData.time">
              <small> (Leave blank for all-day)</small>
            </div>
            <div class="form-group">
              <label for="event-description">Description:</label>
              <textarea id="event-description" x-model="modalData.description"></textarea>
            </div>
            <div class="form-group">
              <label for="event-attendees">Attendees (Emails):</label>
              <input type="text" id="event-attendees" x-model="modalData.attendees"
                placeholder="simulated@example.com, ...">
            </div>
            <div class="form-group">
              <label for="event-meeting-link">Meeting Link:</label>
              <input type="text" id="event-meeting-link" x-model="modalData.meetingLink"
                placeholder="e.g., https://meet.google.com/...">
              <small>(Manually add link. Dynamic generation requires backend)</small>
            </div>

            <div class="modal-actions">
              <button type="button" class="action-btn delete-btn" x-show="editingEventId" @click="deleteEvent"><i
                  class="fas fa-trash"></i> Delete</button>
              <button type="button" class="action-btn simulated-btn" x-show="editingEventId"
                @click="aiReschedule(editingEventId)"><i class="fas fa-magic"></i> AI Reschedule</button>
              <button type="button" class="action-btn simulated-btn" x-show="editingEventId && modalData.meetingLink"
                @click="joinMeet(editingEventId)"><i class="fas fa-video"></i> Join Meet</button>
              <button type="submit" class="action-btn save-btn"><i class="fas fa-save"></i> <span
                  x-text="editingEventId ? 'Update Event' : 'Save Event'"></span></button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    function calendarApp() {
      return {
        currentDate: new Date(), // Date object for the month being viewed
        currentMonthName: '',
        currentYear: '',
        daysInGrid: [], // Array of {dayNum, dateStr, isToday, isCurrentMonth}
        events: [], // Holds all event objects
        isModalOpen: false,
        editingEventId: null, // ID of event being edited, or null for new
        modalData: { // Data bound to the modal form
          title: '',
          startDate: '',
          endDate: '',
          time: '',
          description: '',
          attendees: '',
          meetingLink: ''
        },
        upcomingReminders: [],

        // --- Initialization ---
        init() {
          console.warn("Calendar App Initialized (Alpine.js)");
          console.warn("Reminder: Backend features (Sync, AI, Dynamic Links, Real-time) are simulated/omitted.");
          this.loadSampleEvents(); // Load initial sample data
          this.generateCalendar();
          this.calculateReminders();

          // Watch for changes in events to recalculate reminders
          this.$watch('events', () => this.calculateReminders());
          // Watch for date changes to regenerate calendar
          this.$watch('currentDate', () => this.generateCalendar());
        },

        // --- Date & Calendar Logic ---
        generateCalendar() {
          const year = this.currentDate.getFullYear();
          const month = this.currentDate.getMonth(); // 0-indexed

          this.currentMonthName = this.currentDate.toLocaleString('default', { month: 'long' });
          this.currentYear = year;

          const firstDayOfMonth = new Date(year, month, 1);
          const lastDayOfMonth = new Date(year, month + 1, 0);
          const daysInMonth = lastDayOfMonth.getDate();
          const startDayOfWeek = firstDayOfMonth.getDay(); // 0 = Sunday

          const today = new Date(); today.setHours(0, 0, 0, 0);

          const grid = [];

          // Days from previous month
          const prevLastDay = new Date(year, month, 0).getDate();
          for (let i = startDayOfWeek - 1; i >= 0; i--) {
            const dayNum = prevLastDay - i;
            const date = new Date(year, month - 1, dayNum);
            grid.push({
              dayNum: dayNum,
              dateStr: this.formatDateStr(date),
              isToday: false,
              isCurrentMonth: false
            });
          }

          // Days of current month
          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            date.setHours(0, 0, 0, 0); // Normalize
            grid.push({
              dayNum: day,
              dateStr: this.formatDateStr(date),
              isToday: date.getTime() === today.getTime(),
              isCurrentMonth: true
            });
          }

          // Days from next month
          const totalCells = grid.length;
          const remainingCells = (7 - (totalCells % 7)) % 7;
          for (let i = 1; i <= remainingCells; i++) {
            const date = new Date(year, month + 1, i);
            grid.push({
              dayNum: i,
              dateStr: this.formatDateStr(date),
              isToday: false,
              isCurrentMonth: false
            });
          }
          this.daysInGrid = grid;
        },

        changeMonth(offset) {
          const newDate = new Date(this.currentDate);
          newDate.setMonth(newDate.getMonth() + offset, 1); // Set to 1st to avoid month length issues
          this.currentDate = newDate;
          // generateCalendar will be triggered by the $watch
        },

        formatDateStr(date) {
          // Returns YYYY-MM-DD format
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        },

        formatDate(dateObj, options) {
          if (!dateObj || !(dateObj instanceof Date)) return '';
          return dateObj.toLocaleDateString(undefined, options);
        },


        // --- Event Handling ---
        loadSampleEvents() {
          const todayStr = this.formatDateStr(new Date());
          const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
          const tomorrowStr = this.formatDateStr(tomorrow);
          const nextWeek = new Date(); nextWeek.setDate(nextWeek.getDate() + 7);
          const nextWeekStr = this.formatDateStr(nextWeek);

          this.events = [
            { id: 1, title: 'Team Meeting', startDate: todayStr, endDate: null, time: '10:00', description: 'Weekly sync', attendees: 'a@ex.com', meetingLink: 'https://meet.google.com/sim-ulated' },
            { id: 2, title: 'Project Alpha Conf', startDate: tomorrowStr, endDate: nextWeekStr, time: null, description: 'Conference duration', attendees: 'b@ex.com, c@ex.com', meetingLink: null },
            { id: 3, title: 'Lunch w/ Client', startDate: nextWeekStr, endDate: null, time: '12:00', description: '', attendees: '', meetingLink: null },
            { id: 4, title: 'Birthday Party', startDate: todayStr, endDate: null, time: '19:00', description: 'Celebrate!', attendees: '', meetingLink: null },
          ];
        },

        getEventsForDay(dateStr) {
          if (!dateStr) return [];
          const targetDate = new Date(dateStr + 'T00:00:00'); // Normalize

          return this.events.filter(event => {
            const eventStart = new Date(event.startDate + 'T00:00:00');
            const eventEnd = event.endDate ? new Date(event.endDate + 'T00:00:00') : eventStart;
            return targetDate >= eventStart && targetDate <= eventEnd;
          });
        },

        getIconClass(event) {
          const title = (event?.title || '').toLowerCase();
          if (title.includes('meeting') || title.includes('sync') || title.includes('call') || title.includes('standup')) return 'fas fa-users';
          if (title.includes('lunch') || title.includes('dinner') || title.includes('food') || title.includes('restaurant')) return 'fas fa-utensils';
          if (title.includes('conf') || title.includes('conference') || title.includes('presentation')) return 'fas fa-chalkboard-user';
          if (title.includes('party') || title.includes('birthday') || title.includes('celebrate')) return 'fas fa-birthday-cake';
          if (title.includes('travel') || title.includes('flight') || title.includes('trip')) return 'fas fa-plane';
          if (event?.time && event?.startDate) return 'fas fa-clock';
          return 'fas fa-calendar-day'; // Default
        },

        // --- Modal Logic ---
        resetModalData() {
          this.modalData = { title: '', startDate: '', endDate: '', time: '', description: '', attendees: '', meetingLink: '' };
        },

        openModal(eventId = null, dateStr = null) {
          this.resetModalData();
          this.editingEventId = eventId;

          if (eventId) {
            const event = this.events.find(e => e.id === eventId);
            if (event) {
              // Copy event data to modalData (important: create copy, don't bind directly)
              this.modalData = { ...event };
            } else {
              console.error("Event not found for editing:", eventId);
              this.editingEventId = null; // Reset if not found
            }
          } else {
            // Set start date for new event
            this.modalData.startDate = dateStr || this.formatDateStr(new Date());
          }
          this.isModalOpen = true;
        },

        closeModal() {
          this.isModalOpen = false;
          this.editingEventId = null;
          this.resetModalData(); // Clear data on close
        },

        saveEvent() {
          // Basic validation
          if (!this.modalData.title || !this.modalData.startDate) {
            alert('Please provide at least a title and start date.'); return;
          }
          if (this.modalData.endDate && this.modalData.startDate && this.modalData.endDate < this.modalData.startDate) {
            alert('End date cannot be before the start date.'); return;
          }

          // Sanitize data (ensure nulls where appropriate)
          const dataToSave = {
            ...this.modalData,
            endDate: this.modalData.endDate || null,
            time: this.modalData.time || null,
            meetingLink: this.modalData.meetingLink?.trim() || null
          };


          if (this.editingEventId) {
            // Update existing
            const index = this.events.findIndex(e => e.id === this.editingEventId);
            if (index > -1) {
              // Replace the whole object in the array to ensure reactivity
              this.events.splice(index, 1, { ...dataToSave, id: this.editingEventId });
              console.log("Event Updated (Alpine):", this.events[index]);
            }
          } else {
            // Add new event
            const newEvent = { ...dataToSave, id: Date.now() }; // Simple ID
            this.events.push(newEvent);
            console.log("Event Added (Alpine):", newEvent);
          }
          alert('Event saved! (Simulation)');
          this.closeModal();
          // Calendar will auto-update via reactivity if events array changes
        },

        deleteEvent() {
          if (!this.editingEventId) return;
          if (confirm('Are you sure you want to delete this event?')) {
            this.events = this.events.filter(e => e.id !== this.editingEventId);
            console.log("Event Deleted (Alpine), ID:", this.editingEventId);
            alert('Event deleted! (Simulation)');
            this.closeModal();
          }
        },

        // --- Simulated Actions ---
        joinMeet(eventId) {
          const event = this.events.find(e => e.id === eventId);
          if (event && event.meetingLink) {
            if (event.meetingLink.startsWith('http://') || event.meetingLink.startsWith('https://')) {
              if (confirm(`Open meeting link?\n${event.meetingLink}`)) {
                window.open(event.meetingLink, '_blank');
              }
            } else { alert('Invalid meeting link format.'); }
          } else { alert('No meeting link found.'); }
        },

        aiReschedule(eventId) {
          const event = this.events.find(e => e.id === eventId);
          alert(`Simulating AI rescheduling for "${event?.title || 'event'}"...\n(Requires Backend)`);
          // In real app, would call backend, get suggestions, potentially update event
        },

        // --- Reminders Calculation ---
        calculateReminders() {
          const now = new Date();
          const getDateTime = (event) => {
            const timePart = event.time || '00:00:00';
            try { return new Date(`${event.startDate}T${timePart}`); }
            catch (e) { return new Date(0); } // Invalid date
          };

          this.upcomingReminders = this.events
            .map(event => ({ ...event, dateTime: getDateTime(event) }))
            .filter(event => event.dateTime >= now && event.dateTime.getTime() !== 0)
            .sort((a, b) => a.dateTime - b.dateTime)
            .slice(0, 5); // Limit to 5 reminders
        }
      }
    }
  </script>

</body>

</html>